##################################################################
# ###                                                        ### #
# ### EPICS Database for                                     ### #
# ###   a single channel of ISEG EHS/EDS modules             ### #
# ###                                                        ### #
# ### author: F.Feldbauer                                    ### #
# ###                                                        ### #
# ### Ref 1.0; 2013-02-19                                    ### #
# ###                                                        ### #
# ### macros: subsys  PANDA subsystem      (e.g. FEMC)       ### #
# ###         BUS     AsynPort                               ### #
# ###         dev     detector subtype     (e.g. APD)        ### #
# ###         sector  sector inside subsys (e.g. Q1:X4:Y2:F) ### #
# ###         maxV    Max Value for Vset                     ### #
# ###         maxI    Max Value for Iset                     ### #
##################################################################

############################################################
# ### Read out channel status and channel event status ### #
############################################################
record (mbbiDirect, "PANDA:$(subsys):$(dev):HV:$(sector):Status") {
  field (DTYP, "asynUInt32Digital")
  field (INP,  "@asynMask($(BUS),$(channel),0xffff,1)ISEGHV_CHAN_STATUS")
  field (FLNK, "PANDA:$(subsys):$(dev):HV:$(sector):EventStatus")

  # Bit  0: reserved
  # Bit  1: isREG     0: normal error evaluation  1: fast detection of a regulation error         NOT SUPPORTED
  # Bit  2: IEER      0: no input-error           1: incorrect message to control the module
  # Bit  3: isON      0: channel is off           1: channel is on (Vo is following Vset)
  # Bit  4: isRAMP    0: Vo is stable             1: Vo is ramping
  # Bit  5: isEMCY    0:                          1: channel is in state emergency off
  # Bit  6: isCC      0:                          1: channel is in state of current control
  # Bit  7: isCV      0:                          1: channel is in state of voltage control
  # Bit  8: reserved
  # Bit  9: reserved  
  # Bit 10: isCBND    0: channel is ok            1: |Imeas - Iset| > Ibounds
  # Bit 11: isVBND    0: channel is ok            1: |Vmeas - Vset| > Vbounds
  # Bit 12: isEINH    0: channel is ok            1: External Inhibit was scanned
  # Bit 13: isTRP     0: channel is ok            1: Vo is shut off to 0 V without ramp because the channel has been tripped
  # Bit 14: isCLIM    0: channel is ok            1: the hardware current limit is exceeded
  # Bit 15: isVLIM    0: channel is ok            1: the hardware voltage limit is exceeded
}

record (mbbiDirect, "PANDA:$(subsys):$(dev):HV:$(sector):EventStatus") {
  field (DTYP, "asynUInt32Digital")
  field (INP,  "@asynMask($(BUS),$(channel),0xffff,1)ISEGHV_CHAN_EVENT_STATUS")
  field (FLNK, "PANDA:$(subsys):$(dev):HV:$(sector):Vmom")

  # Bit  0: reserved
  # Bit  1: reserved
  # Bit  2: EIER               0:                      1: Input Error occurred
  # Bit  3: EOn2Off            0:                      1: Channel switched off w/o ramp
  # Bit  4: EEOR               0:                      1: Ramp ended
  # Bit  5: EEMCY              0:                      1: emergency off
  # Bit  6: ECC                0:                      1: current control
  # Bit  7: EVC                0:                      1: voltage control
  # Bit  8: reserved
  # Bit  9: reserved
  # Bit 10: ECBNDs             0:                      1: current is/was out of bounds
  # Bit 11: EVBNDs             0:                      1: voltage is/was out of bounds
  # Bit 12: EEINH              0:                      1: Ext Inhibit signal triggered
  # Bit 13: ETRP               0:                      1: Channel tripped
  # Bit 14: ECLIM              0:                      1: current limit is/was exceeded
  # Bit 15: EVLIM              0:                      1: voltage limit is/was exceeded
}

########################################
# ### Read out voltage and current ### #
########################################
record (ai, "PANDA:$(subsys):$(dev):HV:$(sector):Vmom") {
  field (DTYP, "asynFloat64")
  field (INP,  "@asyn($(BUS),$(channel),1)ISEGHV_CHAN_VMOM")
  # display parameters
  field (EGU,  "V")
  field (PREC, "1")
  # alarm parameters
  field (HIHI, "$(maxV)")
  field (HIGH, "$(maxV)")
  field (LOW,  "-1")
  field (LOLO, "-1")
  field (HHSV, "MAJOR")
  field (HSV,  "MINOR")
  field (LSV,  "MINOR")
  field (LLSV, "MAJOR")
  # thresholds
  field (ADEL, "1")
  field (MDEL, "0")
  field (FLNK, "PANDA:$(subsys):$(dev):HV:$(sector):Imom")
}

record (ai, "PANDA:$(subsys):$(dev):HV:$(sector):Imom") {
  field (DTYP, "asynFloat64")
  field (INP,  "@asyn($(BUS),$(channel),1)ISEGHV_CHAN_IMOM")
  # display parameters
  field (EGU,  "uA")
  field (PREC, "2")
  # alarm parameters
  field (HIHI, "$(maxI)")
  field (HIGH, "$(maxI)")
  field (LOW,  "-1")
  field (LOLO, "-1")
  field (HHSV, "MAJOR")
  field (HSV,  "MINOR")
  field (LSV,  "MINOR")
  field (LLSV, "MAJOR")
  # thresholds
  field (ADEL, "1")
  field (MDEL, "0")
}

####################
# ### switches ### #
####################
record (bo, "PANDA:$(subsys):HV:Switch") {
  field (DTYP, "asynUInt32Digital")
  field (OUT,  "@asynMask(iseg,0,1,1)ISEGHV_SWITCHONOFF")
  field (ZNAM, "OFF")
  field (ONAM, "ON")
}

record (bo, "PANDA:$(subsys):HV:EmergencyOff") {
  field (DTYP, "asynInt32")
  field (OUT,  "@asyn(iseg,0,1)ISEGHV_EMERGENCYOFF")
  field (ZNAM, "OFF")
  field (ONAM, "ON")
}

##########################
# ### Module Control ### #
##########################
# Bit  0: reserved
# Bit  1: reserved
# Bit  2: reserved
# Bit  3: reserved
# Bit  4: reserved
# Bit  5: setILK: Interlock: Interlock signal CRATE_ENABLE (WIENER MPOD crate, active TTL high
#         1: INTERLOCK singal in order to switch off HV and set bit EEINH of the EventStatus for all channels
#         0: reset the INTERLOCK signal in order to clear the bit EEINH of the EventStatus for all channels
# Bit  6: doCLEAR: ClearKill: Hardware ClearKill signal and clear all event singals of the module and the channels
#         1: Hardware ClearKill signal and clear all event signals of the module and the channels
#         0: no action
# Bit  7: reserved
# Bit  8: reserved
# Bit  9: reserved
# Bit 10: reserved
# Bit 11: setENDN: Endian: Order of bytes in word: 0 = Little Endian (INTEL); 1 = Big Endian (MOTOROLA)
#         1: big endian
#         0: little endian
#         SET CONSTANTLY TO 1
# Bit 12: setADJ: Adjust: Switch ON of fine adjustment
#         1: fine adjustment ON
#         0: fine adjustment OFF
#         SET CONSTANTLY TO 1
# Bit 13: reserved
# Bit 14: setKILena: KillEnable: Kill function
#         1: kill function enable
#         0: kill function disable
#         SET CONSTANTLY TO 1
# Bit 15: reserved

record (bo, "PANDA:$(subsys):$(dev):HV:$(sector):doCLEAR") {
  field (DTYP, "asynInt32")
  field (OUT,  "@asyn($(BUS),0,1)ISEGHV_CLEAR_EVENT_STATUS")
}

record (ao, "PANDA:$(subsys):$(dev):HV:$(sector):VoltageRampSpeed") {
  field (DTYP, "asynFloat64")
  field (OUT,  "@asyn($(BUS),0,1)ISEGHV_RAMPSPEED")
  field (VAL,  "4")
  field (DRVH, "20")
  field (DRVL, "0")
  field (PREC, "1")
  field (EGU,  "p.c.")
}

###################################
# ### Set voltage and current ### #
###################################
record (ao, "PANDA:$(subsys):$(dev):HV:$(sector):Vset") {
  field (DTYP, "asynFloat64")
  field (OUT,  "@asyn($(BUS),$(channel),1)ISEGHV_CHAN_VSET")
  field (DRVH, "$(maxV)")
  field (DRVL, "0")
  field (PREC, "1")
  field (EGU,  "V")
}

record (ao, "PANDA:$(subsys):$(dev):HV:$(sector):Iset") {
  field (DTYP, "asynFloat64")
  field (OUT,  "@asyn($(BUS),$(channel),1)ISEGHV_CHAN_ISET")
  field (DRVH, "$(maxI)")
  field (DRVL, "0")
  field (PREC, "2")
  field (EGU,  "uA")
}

##########################
# ### Channel status ### #
##########################
record (bi, "PANDA:$(subsys):$(dev):HV:$(sector):IEER") {
  field (INP,  "PANDA:$(subsys):$(dev):HV:$(sector):Status.B2 CP")
  field (ZNAM, "OK")
  field (ONAM, "Input Error")
  field (ZSV,  "NO_ALARM")
  field (OSV,  "MINOR")
}

record (bi, "PANDA:$(subsys):$(dev):HV:$(sector):isOn") {
  field (INP,  "PANDA:$(subsys):$(dev):HV:$(sector):Status.B3 CP")
  field (ZNAM, "off")
  field (ONAM, "on")
  field (ZSV,  "NO_ALARM")
  field (OSV,  "NO_ALARM")
}

record (bi, "PANDA:$(subsys):$(dev):HV:$(sector):isRamp") {
  field (INP,  "PANDA:$(subsys):$(dev):HV:$(sector):Status.B4 CP")
  field (ZNAM, "stable")
  field (ONAM, "ramping")
  field (ZSV,  "NO_ALARM")
  field (OSV,  "NO_ALARM")
}

record (bi, "PANDA:$(subsys):$(dev):HV:$(sector):isEMCY") {
  field (INP,  "PANDA:$(subsys):$(dev):HV:$(sector):Status.B5 CP")
  field (ZNAM, "-")
  field (ONAM, "active")
  field (ZSV,  "NO_ALARM")
  field (OSV,  "MAJOR")
}

record (bi, "PANDA:$(subsys):$(dev):HV:$(sector):isCC") {
  field (INP,  "PANDA:$(subsys):$(dev):HV:$(sector):Status.B6 CP")
  field (ZNAM, "-")
  field (ONAM, "active")
  field (ZSV,  "NO_ALARM")
  field (OSV,  "MAJOR")
}

record (bi, "PANDA:$(subsys):$(dev):HV:$(sector):isCV") {
  field (INP,  "PANDA:$(subsys):$(dev):HV:$(sector):Status.B7 CP")
  field (ZNAM, "-")
  field (ONAM, "active")
  field (ZSV,  "NO_ALARM")
  field (OSV,  "NO_ALARM")
}

record (bi, "PANDA:$(subsys):$(dev):HV:$(sector):isCBND") {
  field (INP,  "PANDA:$(subsys):$(dev):HV:$(sector):Status.BA CP")
  field (ZNAM, "OK")
  field (ONAM, "Out of bounds")
  field (ZSV,  "NO_ALARM")
  field (OSV,  "MAJOR")
}

record (bi, "PANDA:$(subsys):$(dev):HV:$(sector):isVBND") {
  field (INP,  "PANDA:$(subsys):$(dev):HV:$(sector):Status.BB CP")
  field (ZNAM, "OK")
  field (ONAM, "Out of bounds")
  field (ZSV,  "NO_ALARM")
  field (OSV,  "MAJOR")
}

record (bi, "PANDA:$(subsys):$(dev):HV:$(sector):isEINH") {
  field (INP,  "PANDA:$(subsys):$(dev):HV:$(sector):Status.BC CP")
  field (ZNAM, "no")
  field (ONAM, "yes")
  field (ZSV,  "NO_ALARM")
  field (OSV,  "MAJOR")
}

record (bi, "PANDA:$(subsys):$(dev):HV:$(sector):isTRP") {
  field (INP,  "PANDA:$(subsys):$(dev):HV:$(sector):Status.BD CP")
  field (ZNAM, "OK")
  field (ONAM, "tripped")
  field (ZSV,  "NO_ALARM")
  field (OSV,  "NO_ALARM")
}

record (bi, "PANDA:$(subsys):$(dev):HV:$(sector):isCLIM") {
  field (INP,  "PANDA:$(subsys):$(dev):HV:$(sector):Status.BE CP")
  field (ZNAM, "OK")
  field (ONAM, "exceeded")
  field (ZSV,  "NO_ALARM")
  field (OSV,  "MAJOR")
}

record (bi, "PANDA:$(subsys):$(dev):HV:$(sector):isVLIM") {
  field (INP,  "PANDA:$(subsys):$(dev):HV:$(sector):Status.BF CP")
  field (ZNAM, "OK")
  field (ONAM, "exceeded")
  field (ZSV,  "NO_ALARM")
  field (OSV,  "MAJOR")
}

################################
# ### Channel event status ### #
################################
record (bi, "PANDA:$(subsys):$(dev):HV:$(sector):EIER") {
  field (INP,  "PANDA:$(subsys):$(dev):HV:$(sector):EventStatus.B2 CP")
  field (ZNAM, "--")
  field (ONAM, "active")
  field (ZSV,  "NO_ALARM")
  field (OSV,  "MINOR")
}

record (bi, "PANDA:$(subsys):$(dev):HV:$(sector):EOn2Off") {
  field (INP,  "PANDA:$(subsys):$(dev):HV:$(sector):EventStatus.B3 CP")
  field (ZNAM, "--")
  field (ONAM, "active")
  field (ZSV,  "NO_ALARM")
  field (OSV,  "MAJOR")
}

record (bi, "PANDA:$(subsys):$(dev):HV:$(sector):EEOR") {
  field (INP,  "PANDA:$(subsys):$(dev):HV:$(sector):EventStatus.B4 CP")
  field (ZNAM, "--")
  field (ONAM, "active")
  field (ZSV,  "NO_ALARM")
  field (OSV,  "NO_ALARM")
}

record (bi, "PANDA:$(subsys):$(dev):HV:$(sector):EEMCY") {
  field (INP,  "PANDA:$(subsys):$(dev):HV:$(sector):EventStatus.B5 CP")
  field (ZNAM, "--")
  field (ONAM, "active")
  field (ZSV,  "NO_ALARM")
  field (OSV,  "NO_ALARM")
}

record (bi, "PANDA:$(subsys):$(dev):HV:$(sector):ECC") {
  field (INP,  "PANDA:$(subsys):$(dev):HV:$(sector):EventStatus.B6 CP")
  field (ZNAM, "--")
  field (ONAM, "active")
  field (ZSV,  "NO_ALARM")
  field (OSV,  "MAJOR")
}

record (bi, "PANDA:$(subsys):$(dev):HV:$(sector):ECV") {
  field (INP,  "PANDA:$(subsys):$(dev):HV:$(sector):EventStatus.B7 CP")
  field (ZNAM, "--")
  field (ONAM, "active")
  field (ZSV,  "NO_ALARM")
  field (OSV,  "NO_ALARM")
}

record (bi, "PANDA:$(subsys):$(dev):HV:$(sector):ECBNDs") {
  field (INP,  "PANDA:$(subsys):$(dev):HV:$(sector):EventStatus.BA CP")
  field (ZNAM, "--")
  field (ONAM, "active")
  field (ZSV,  "NO_ALARM")
  field (OSV,  "MAJOR")
}

record (bi, "PANDA:$(subsys):$(dev):HV:$(sector):EVBNDs") {
  field (INP,  "PANDA:$(subsys):$(dev):HV:$(sector):EventStatus.BB CP")
  field (ZNAM, "--")
  field (ONAM, "active")
  field (ZSV,  "NO_ALARM")
  field (OSV,  "MAJOR")
}

record (bi, "PANDA:$(subsys):$(dev):HV:$(sector):EEINH") {
  field (INP,  "PANDA:$(subsys):$(dev):HV:$(sector):EventStatus.BC CP")
  field (ZNAM, "--")
  field (ONAM, "active")
  field (ZSV,  "NO_ALARM")
  field (OSV,  "MAJOR")
}

record (bi, "PANDA:$(subsys):$(dev):HV:$(sector):ETRP") {
  field (INP,  "PANDA:$(subsys):$(dev):HV:$(sector):EventStatus.BD CP")
  field (ZNAM, "--")
  field (ONAM, "active")
  field (ZSV,  "NO_ALARM")
  field (OSV,  "MAJOR")
}

record (bi, "PANDA:$(subsys):$(dev):HV:$(sector):ECLIM") {
  field (INP,  "PANDA:$(subsys):$(dev):HV:$(sector):EventStatus.BE CP")
  field (ZNAM, "--")
  field (ONAM, "active")
  field (ZSV,  "NO_ALARM")
  field (OSV,  "MAJOR")
}

record (bi, "PANDA:$(subsys):$(dev):HV:$(sector):EVLIM") {
  field (INP,  "PANDA:$(subsys):$(dev):HV:$(sector):EventStatus.BF CP")
  field (ZNAM, "--")
  field (ONAM, "active")
  field (ZSV,  "NO_ALARM")
  field (OSV,  "MAJOR")
}

###############
# ### EOF ### #
###############
