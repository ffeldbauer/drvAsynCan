#####################################################
# ###                                           ### #
# ### EPICS Database for                        ### #
# ### THMP CAN Communication                    ### #
# ###                                           ### #
# ### author: F.Feldbauer                       ### #
# ###                                           ### #
# ### Ref 1.0; 2012-09-17                       ### #
# ###                                           ### #
# ### macros: subsys  PANDA subsystem           ### #
# ###         BUS     Asyn Port                 ### #
# ###         ID      CAN id of THMP            ### #
# ###         NUM     Number of Piggyback board ### #
# ###         NUM2    $(NUM) + 9                ### #
# ###         SERIAL1 higher 3 bytes of serial  ### #
# ###         SERIAL2 lower 3 bytes of serial   ### #
#####################################################

####################
# ### Triggers ### #
####################
record (bo, "PANDA:$(subsys):THMP:$(ID):TriggerAdcBuffer") {
  field (DTYP, "asynInt32")
  field (OUT,  "@asyn($(BUS),0,1)ReadoutADC")
}

record (bo, "PANDA:$(subsys):THMP:$(ID):TriggerSerials") {
  field (DTYP, "asynInt32")
  field (OUT,  "@asyn($(BUS),0,1)ReadoutSerials")
}

record (mbbi, "PANDA:$(subsys):THMP:$(ID):Error") {
  field (DTYP, "asynUInt32Digital")
  field (SCAN, "I/O Intr")
  field (INP,  "@asynMask($(BUS),0,0xffff,1)Error")
}

#####################
# ### I/O Board ### #
#####################
record (mbbiDirect, "PANDA:$(subsys):THMP:$(ID):READIO0") {
  field (DTYP, "asynUInt32Digital")
  field (SCAN, "I/O Intr")
  field (INP,  "@asynMask($(BUS),0,0xffff,1)IOBoard")
}

record (mbbiDirect, "PANDA:$(subsys):THMP:$(ID):READIO1") {
  field (DTYP, "asynUInt32Digital")
  field (SCAN, "I/O Intr")
  field (INP,  "@asynMask($(BUS),1,0xffff,1)IOBoard")
}

record (mbboDirect, "PANDA:$(subsys):THMP:$(ID):WRITEIO0") {
  field (DTYP, "asynUInt32Digital")
  field (OUT,  "@asynMask($(BUS),0,0xffff,1)IOBoard")
}

record (mbboDirect, "PANDA:$(subsys):THMP:$(ID):WRITEIO1") {
  field (DTYP, "asynUInt32Digital")
  field (OUT,  "@asynMask($(BUS),1,0xffff,1)IOBoard")
}

record (mbbo, "PANDA:$(subsys):THMP:$(ID):CONFIGIO0") {
  field (DTYP, "asynInt32")
  field (OUT,  "@asyn($(BUS),0,1)ConfigIO")
}

record (mbbo, "PANDA:$(subsys):THMP:$(ID):CONFIGIO1") {
  field (DTYP, "asynInt32")
  field (OUT,  "@asyn($(BUS),1,1)ConfigIO")
}

######################
# ### SERIAL IDs ### #
######################
record (longin, "PANDA:$(subsys):THMP:$(ID):SERIAL:$(NUM):1") {
  field (DTYP, "asynUInt32Digital")
  field (INP,  "@asynMask($(BUS),$(NUM),0xffffff,1)Serial")
  field (SCAN, "I/O Intr")
  field (FLNK, "PANDA:$(subsys):THMP:$(ID):SERIAL:$(NUM):2")
}

record (longin, "PANDA:$(subsys):THMP:$(ID):SERIAL:$(NUM):2") {
  field (DTYP, "asynUInt32Digital")
  field (INP,  "@asynMask($(BUS),$(NUM2),0xffffff,1)Serial")
  field (FLNK, "PANDA:$(subsys):THMP:$(ID):SERIAL:$(NUM)")
}

record (calc, "PANDA:$(subsys):THMP:$(ID):SERIAL:$(NUM)") {
  field (INPA, "PANDA:$(subsys):THMP:$(ID):SERIAL:$(NUM):1 CP")
  field (INPB, "$(SERIAL1)")
  field (INPC, "PANDA:$(subsys):THMP:$(ID):SERIAL:$(NUM):2 CP")
  field (INPD, "$(SERIAL2)")

  field (CALC, "(A XOR B) OR (C XOR D)")
  # if serials match, VAL is 0 => every other value should be an alarm!

  field (HIGH, "1")
  field (HSV,  "MAJOR")
  field (LOW,  "-1")
  field (LSV,  "MAJOR")
}
