##################################################################
# ###                                                        ### #
# ### EPICS Database for                                     ### #
# ###   module related commands of ISEG EHS/EDS modules      ### #
# ###                                                        ### #
# ### author: F.Feldbauer                                    ### #
# ###                                                        ### #
# ### Ref 1.0; 2013-02-19                                    ### #
# ###                                                        ### #
# ### macros: subsys  PANDA subsystem      (e.g. FEMC)       ### #
# ###         BUS     AsynPort                               ### #
# ###         sector  sector inside subsys (e.g. Q1:X4:Y2)   ### #
##################################################################

##########################################################
# ### Read out module status and module event status ### #
##########################################################
record( mbbiDirect, "PANDA:$(subsys):HV:$(sector):ModStatus" ) {
  field( DTYP, "asynUInt32Digital" )
  field( DISV, "0" )
  field( SDIS, "PANDA:$(subsys):HVCRATE:$(crate):PowerOn.VAL NPP MS" )
  field( INP,  "@asynMask($(BUS),0,0xffff,1)ModuleStatus" )
  field( FLNK, "PANDA:$(subsys):HV:$(sector):ModEventStatus" )
}

record( mbbiDirect, "PANDA:$(subsys):HV:$(sector):ModEventStatus" ) {
  field( DTYP, "asynUInt32Digital" )
  field( DISV, "0" )
  field( SDIS, "PANDA:$(subsys):HVCRATE:$(crate):PowerOn.VAL NPP MS" )
  field( INP,  "@asynMask($(BUS),0,0xffff,1)ModuleEventStatus" )
  field( FLNK, "PANDA:$(subsys):HV:$(sector):BoardTemperature" )
}

record( mbboDirect, "PANDA:$(subsys):HV:$(sector):ModEventMask" ) {
  field( DTYP, "asynUInt32Digital" )
  field( DISV, "0" )
  field( SDIS, "PANDA:$(subsys):HVCRATE:$(crate):PowerOn.VAL NPP MS" )
  field( OUT,  "@asynMask($(BUS),0,0xffff,1)ModuleEventMask" )
}

######################################
# ### Read out board temperature ### #
######################################
record( ai, "PANDA:$(subsys):HV:$(sector):BoardTemperature" ) {
  field( DTYP, "asynFloat64" )
  field( DISV, "0" )
  field( SDIS, "PANDA:$(subsys):HVCRATE:$(crate):PowerOn.VAL NPP MS" )
  field( INP,  "@asyn($(BUS),0,1)BoardTemperature" )
  # display parameters
  field( EGU,  "degC" )
  field( PREC, "2" )
  # Alarm parameters
  field( HIHI, "50" )
  field( HIGH, "40" )
  field( LOW,  "0" )
  field( LOLO, "0" )
  field( HHSV, "MAJOR" )
  field( HSV,  "MINOR" )
  field( LSV,  "NO_ALARM" )
  field( LLSV, "NO_ALARM" )
  # thresholds
  field( ADEL, "0.5" )
  field( MDEL, "0" )
  field( FLNK, "PANDA:$(subsys):HV:$(sector):ReadChanStat" )
}

###########################
# ### read parameters ### #
###########################
record( ai, "PANDA:$(subsys):HV:$(sector):MaxVoltage" ) {
  field( DTYP, "asynFloat64" )
  field( DISV, "0" )
  field( SDIS, "PANDA:$(subsys):HVCRATE:$(crate):PowerOn.VAL NPP MS" )
  field( INP,  "@asyn($(BUS),0,1)VoltageMax" 
}

record( ai, "PANDA:$(subsys):HV:$(sector):MaxCurrent" ) {
  field( DTYP, "asynFloat64" )
  field( DISV, "0" )
  field( SDIS, "PANDA:$(subsys):HVCRATE:$(crate):PowerOn.VAL NPP MS" )
  field( INP,  "@asyn($(BUS),0,1)CurrentMax" 
}

###########################
# ### read parameters ### #
###########################
record( bo, "PANDA:$(subsys):HV:$(sector):ReadChanStat" ) {
  field( DTYP, "asynInt32" )
  field( DISV, "0" )
  field( SDIS, "PANDA:$(subsys):HVCRATE:$(crate):PowerOn.VAL NPP MS" )
  field( OUT,  "@asyn($(BUS),0,1)ReadChannelStatus" )
  field( FLNK, "PANDA:$(subsys):HV:$(sector):ReadChanEvtStat" )
}
record( bo, "PANDA:$(subsys):HV:$(sector):ReadChanEvtStat" ) {
  field( DTYP, "asynInt32" )
  field( DISV, "0" )
  field( SDIS, "PANDA:$(subsys):HVCRATE:$(crate):PowerOn.VAL NPP MS" )
  field( OUT,  "@asyn($(BUS),0,1)ReadChannelEventStatus" )
  field( FLNK, "PANDA:$(subsys):HV:$(sector):ReadChanVmom" )
}
record( bo, "PANDA:$(subsys):HV:$(sector):ReadChanVmom" ) {
  field( DTYP, "asynInt32" )
  field( DISV, "0" )
  field( SDIS, "PANDA:$(subsys):HVCRATE:$(crate):PowerOn.VAL NPP MS" )
  field( OUT,  "@asyn($(BUS),0,1)ReadVoltageMeasure" )
  field( FLNK, "PANDA:$(subsys):HV:$(sector):ReadChanImom" )
}
record( bo, "PANDA:$(subsys):HV:$(sector):ReadChanImom" ) {
  field( DTYP, "asynInt32" )
  field( DISV, "0" )
  field( SDIS, "PANDA:$(subsys):HVCRATE:$(crate):PowerOn.VAL NPP MS" )
  field( OUT,  "@asyn($(BUS),0,1)ReadCurrentMeasure" )
}

####################
# ### switches ### #
####################
record( bo, "PANDA:$(subsys):HV:Switch" ) {
  field( DTYP, "asynUInt32Digital" )
  field( DISV, "0" )
  field( SDIS, "PANDA:$(subsys):HVCRATE:$(crate):PowerOn.VAL NPP MS" )
  field( OUT,  "@asynMask(isegGlobal,0,1,1)SWITCHONOFF" )
  field( ZNAM, "OFF" )
  field( ONAM, "ON" )
}

record( bo, "PANDA:$(subsys):HV:EmergencyOff" ) {
  field( DTYP, "asynInt32" )
  field( DISV, "0" )
  field( SDIS, "PANDA:$(subsys):HVCRATE:$(crate):PowerOn.VAL NPP MS" )
  field( OUT,  "@asyn(isegGlobal,0,1)EMERGENCYOFF" )
  field( ZNAM, "OFF" )
  field( ONAM, "ON" )
}

##########################
# ### Module Control ### #
##########################
# Bit  0: reserved
# Bit  1: reserved
# Bit  2: reserved
# Bit  3: reserved
# Bit  4: reserved
# Bit  5: setILK: Interlock: Interlock signal CRATE_ENABLE (WIENER MPOD crate, active TTL high
#         1: INTERLOCK singal in order to switch off HV and set bit EEINH of the EventStatus for all channels
#         0: reset the INTERLOCK signal in order to clear the bit EEINH of the EventStatus for all channels
# Bit  6: doCLEAR: ClearKill: Hardware ClearKill signal and clear all event singals of the module and the channels
#         1: Hardware ClearKill signal and clear all event signals of the module and the channels
#         0: no action
# Bit  7: reserved
# Bit  8: reserved
# Bit  9: reserved
# Bit 10: reserved
# Bit 11: setENDN: Endian: Order of bytes in word: 0 = Little Endian (INTEL); 1 = Big Endian (MOTOROLA)
#         1: big endian
#         0: little endian
#         SET CONSTANTLY TO 1
# Bit 12: setADJ: Adjust: Switch ON of fine adjustment
#         1: fine adjustment ON
#         0: fine adjustment OFF
#         SET CONSTANTLY TO 1
# Bit 13: reserved
# Bit 14: setKILena: KillEnable: Kill function
#         1: kill function enable
#         0: kill function disable
#         SET CONSTANTLY TO 1
# Bit 15: reserved

record( mbboDirect, "PANDA:$(subsys):HV:$(sector):ModCtrl" ) {
  field( DTYP, "asynUInt32Digital" )
  field( DISV, "0" )
  field( SDIS, "PANDA:$(subsys):HVCRATE:$(crate):PowerOn.VAL NPP MS" )
  field( OUT,  "@asynMask($(BUS),0,0xffff,1)ModuleControl" )
}

record( bo, "PANDA:$(subsys):HV:$(sector):doCLEAR" ) {
  field( DTYP, "Soft Channel" )
  field( VAL,  "1" )
  field( OUT,  "PANDA:$(subsys):HV:$(sector):ModCtrl.B6" )
}

record( ao, "PANDA:$(subsys):HV:$(sector):VoltageRampSpeed" ) {
  field( DTYP, "asynFloat64" )
  field( DISV, "0" )
  field( SDIS, "PANDA:$(subsys):HVCRATE:$(crate):PowerOn.VAL NPP MS" )
  field( OUT,  "@asyn($(BUS),0,1)VoltageRampSpeed" )
  field( DRVH, "20" )
  field( DRVL, "0" )
  field( PREC, "1" )
  field( EGU,  "p.c." )
}

#########################
# ### Module status ### #
#########################
record( bi, "PANDA:$(subsys):HV:$(sector):isADJ" ) {
  field( INP,  "PANDA:$(subsys):HV:$(sector):ModStatus.B0 CP" )
  field( ZNAM, "off" )
  field( ONAM, "on" )
  field( ZSV,  "NO_ALARM" )
  field( OSV,  "NO_ALARM" )
}

record( bi, "PANDA:$(subsys):HV:$(sector):isLVINS" ) {
  field( INP,  "PANDA:$(subsys):HV:$(sector):ModStatus.B2 CP" )
  field( ZNAM, "off" )
  field( ONAM, "on" )
  field( ZSV,  "NO_ALARM" )
  field( OSV,  "NO_ALARM" )
}

record( bi, "PANDA:$(subsys):HV:$(sector):needSrvc" ) {
  field( INP,  "PANDA:$(subsys):HV:$(sector):ModStatus.B4 CP" )
  field( ZNAM, "ok" )
  field( ONAM, "Hardware failure detected" )
  field( ZSV,  "NO_ALARM" )
  field( OSV,  "MAJOR" )
}

record( bi, "PANDA:$(subsys):HV:$(sector):isIERR" ) {
  field( INP,  "PANDA:$(subsys):HV:$(sector):ModStatus.B6 CP" )
  field( ZNAM, "ok" )
  field( ONAM, "Error" )
  field( ZSV,  "NO_ALARM" )
  field( OSV,  "MINOR" )
}

record( bi, "PANDA:$(subsys):HV:$(sector):isnoSERR" ) {
  field( INP,  "PANDA:$(subsys):HV:$(sector):ModStatus.B8 CP" )
  field( ZNAM, "Error" )
  field( ONAM, "ok" )
  field( ZSV,  "MAJOR" )
  field( OSV,  "NO_ALARM" )
}

record( bi, "PANDA:$(subsys):HV:$(sector):isnoRAMP" ) {
  field( INP,  "PANDA:$(subsys):HV:$(sector):ModStatus.B9 CP" )
  field( ZNAM, "channel is ramping" )
  field( ONAM, "all channels stable" )
  field( ZSV,  "NO_ALARM" )
  field( OSV,  "NO_ALARM" )
}

record( bi, "PANDA:$(subsys):HV:$(sector):isSFLPgd" ) {
  field( INP,  "PANDA:$(subsys):HV:$(sector):ModStatus.BA CP" )
  field( ZNAM, "broken" )
  field( ONAM, "closed" )
  field( ZSV,  "MAJOR" )
  field( OSV,  "NO_ALARM" )
}

record( bi, "PANDA:$(subsys):HV:$(sector):isEVNTact" ) {
  field( INP,  "PANDA:$(subsys):HV:$(sector):ModStatus.BB CP" )
  field( ZNAM, "no active Event" )
  field( ONAM, "any event active" )
  field( ZSV,  "NO_ALARM" )
  field( OSV,  "NO_ALARM" )
}

record( bi, "PANDA:$(subsys):HV:$(sector):isMODgd" ) {
  field( INP,  "PANDA:$(subsys):HV:$(sector):ModStatus.BC CP" )
  field( ZNAM, "failure" )
  field( ONAM, "ok" )
  field( ZSV,  "MAJOR" )
  field( OSV,  "NO_ALARM" )
}

record( bi, "PANDA:$(subsys):HV:$(sector):isSPLYgd" ) {
  field( INP,  "PANDA:$(subsys):HV:$(sector):ModStatus.BD CP" )
  field( ZNAM, "Out of Range" )
  field( ONAM, "ok" )
  field( ZSV,  "MAJOR" )
  field( OSV,  "NO_ALARM" )
}

record( bi, "PANDA:$(subsys):HV:$(sector):isTMPgd" ) {
  field( INP,  "PANDA:$(subsys):HV:$(sector):ModStatus.BE CP" )
  field( ZNAM, "above 55 degC" )
  field( ONAM, "within range" )
  field( ZSV,  "MAJOR" )
  field( OSV,  "NO_ALARM" )
}

record( bi, "PANDA:$(subsys):HV:$(sector):isKILena" ) {
  field( INP,  "PANDA:$(subsys):HV:$(sector):ModStatus.BF CP" )
  field( ZNAM, "disabled" )
  field( ONAM, "enabled" )
  field( ZSV,  "NO_ALARM" )
  field( OSV,  "NO_ALARM" )
}

###############################
# ### Module Event status ### #
###############################
record( bi, "PANDA:$(subsys):HV:$(sector):ELVINS" ) {
  field( INP,  "PANDA:$(subsys):HV:$(sector):ModEventStatus.B2 CP" )
  field( ZNAM, "off" )
  field( ONAM, "on" )
  field( ZSV,  "NO_ALARM" )
  field( OSV,  "NO_ALARM" )
}

record( bi, "PANDA:$(subsys):HV:$(sector):ESrvc" ) {
  field( INP,  "PANDA:$(subsys):HV:$(sector):ModEventStatus.B4 CP" )
  field( ZNAM, "-" )
  field( ONAM, "Hardware failure detected" )
  field( ZSV,  "NO_ALARM" )
  field( OSV,  "MAJOR" )
}

record( bi, "PANDA:$(subsys):HV:$(sector):EIERR" ) {
  field( INP,  "PANDA:$(subsys):HV:$(sector):ModEventStatus.B6 CP" )
  field( ZNAM, "-" )
  field( ONAM, "Input Error in connection" )
  field( ZSV,  "NO_ALARM" )
  field( OSV,  "MAJOR" )
}

record( bi, "PANDA:$(subsys):HV:$(sector):ESFLPngd" ) {
  field( INP,  "PANDA:$(subsys):HV:$(sector):ModEventStatus.BA CP" )
  field( ZNAM, "-" )
  field( ONAM, "Safety loop open" )
  field( ZSV,  "NO_ALARM" )
  field( OSV,  "MAJOR" )
}

record( bi, "PANDA:$(subsys):HV:$(sector):ESPLYngd" ) {
  field( INP,  "PANDA:$(subsys):HV:$(sector):ModEventStatus.BD CP" )
  field( ZNAM, "-" )
  field( ONAM, "Supply is not good" )
  field( ZSV,  "NO_ALARM" )
  field( OSV,  "MAJOR" )
}

record( bi, "PANDA:$(subsys):HV:$(sector):ETMPngd" ) {
  field( INP,  "PANDA:$(subsys):HV:$(sector):ModEventStatus.BD CP" )
  field( ZNAM, "-" )
  field( ONAM, "Temperature above 55 degC" )
  field( ZSV,  "NO_ALARM" )
  field( OSV,  "MAJOR" )
}
