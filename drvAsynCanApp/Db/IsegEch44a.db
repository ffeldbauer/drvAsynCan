##################################################################
# ###                                                        ### #
# ### EPICS Database for                                     ### #
# ###   ISEG ECH44A Crate Controller                         ### #
# ###                                                        ### #
# ### author: F.Feldbauer                                    ### #
# ###                                                        ### #
# ### Ref 1.0; 2014-05-22                                    ### #
# ###                                                        ### #
# ### macros: subsys  PANDA subsystem      (e.g. FEMC)       ### #
# ###         BUS     AsynPort                               ### #
# ###         sector  sector inside subsys (e.g. Q1:X4:Y2)   ### #
##################################################################

record( seq, "PANDA:$(subsys):HVCRATE:$(sector):SCAN" ){
  field( SCAN, "1 second" )
  field( PREC, "1" )
  field( LNK1, "PANDA:$(subsys):HVCRATE:$(sector):StatusRead__.PROC PP MS" )
  field( DLY2, "0.02" )
  field( LNK2, "PANDA:$(subsys):HVCRATE:$(sector):EvtStatusRead__.PROC PP MS" )
}

record( longin, "PANDA:$(subsys):HVCRATE:$(sector):StatusRead__" ) {
  field( DTYP, "asynUInt32Digital" )
  field( INP,  "@asynMask($(BUS),0,0xffff,1)STATUS" )
}

record( calc, "PANDA:$(subsys):HVCRATE:$(sector):StatusSplit" ) {
  field( INPA, "PANDA:$(subsys):HVCRATE:$(sector):StatusRead CP" )
  field( INPB, "0x0000ffff" )
  field( INPC, "0xffff0000" )
  field( CALC, "d:=(A&B); (A&C)>>16" )
}

record( mbbiDirect, "PANDA:$(subsys):HVCRATE:$(sector):StatusLow" ) {
  field( INP,  "PANDA:$(subsys):HVCRATE:$(sector):StatusSplit.D CP" )

  # Bit  0: Low +24 Battery
  # Bit  1: High +24 Battery
  # Bit  2: Low +5 Backplane
  # Bit  3: High +5 Backplane
  # Bit  4: Low +24 Backplane
  # Bit  5: High +24 Backplane
  # Bit  6: Service
  # Bit  7: High Temp
  # Bit  8: Low +5 CPU
  # Bit  9: High +5 CPU
  # Bit 10: Low +3.3 CPU
  # Bit 11: High +3.3 CPU
  # Bit 12: 
  # Bit 13: 
  # Bit 14: 
  # Bit 15: 
}

record( mbbiDirect, "PANDA:$(subsys):HVCRATE:$(sector):StatusHigh" ) {
  field( INP,  "PANDA:$(subsys):HVCRATE:$(sector):StatusSplit.VAL CP" )

  # Bit  0: Power ON
  # Bit  1: Power Fail
  # Bit  2: HV On
  # Bit  3: Shut PC
  # Bit  4: 
  # Bit  5: 
  # Bit  6: 
  # Bit  7: 
  # Bit  8: 
  # Bit  9: 
  # Bit 10: 
  # Bit 11: 
  # Bit 12: 
  # Bit 13: 
  # Bit 14: 
  # Bit 15: 
}

record( longin, "PANDA:$(subsys):HVCRATE:$(sector):EvtStatusRead__" ) {
  field( DTYP, "asynUInt32Digital" )
  field( INP,  "@asynMask($(BUS),0,0xffff,1)EVT_STATUS" )
}

record( calc, "PANDA:$(subsys):HVCRATE:$(sector):EvtStatusSplit__" ) {
  field( INPA, "PANDA:$(subsys):HVCRATE:$(sector):EvtStatusRead CP" )
  field( INPB, "0x0000ffff" )
  field( INPC, "0xffff0000" )
  field( CALC, "d:=(A&B); (A&C)>>8" )
}

record( mbbiDirect, "PANDA:$(subsys):HVCRATE:$(sector):EvtStatusLow" ) {
  field( INP,  "PANDA:$(subsys):HVCRATE:$(sector):EvtStatusSplit.D CP" )

  # Bit  0: Low +24 Battery
  # Bit  1: High +24 Battery
  # Bit  2: Low +5 Backplane
  # Bit  3: High +5 Backplane
  # Bit  4: Low +24 Backplane
  # Bit  5: High +24 Backplane
  # Bit  6: Service
  # Bit  7: High Temp
  # Bit  8: Low +5 CPU
  # Bit  9: High +5 CPU
  # Bit 10: Low +3.3 CPU
  # Bit 11: High +3.3 CPU
  # Bit 12: 
  # Bit 13: 
  # Bit 14: 
  # Bit 15: 
}

record( mbbiDirect, "PANDA:$(subsys):HVCRATE:$(sector):EvtStatusHigh" ) {
  field( INP,  "PANDA:$(subsys):HVCRATE:$(sector):EvtStatusSplit.VAL CP" )

  # Bit  0: Power ON
  # Bit  1: Power Fail
  # Bit  2: HV On
  # Bit  3: Shut PC
  # Bit  4: 
  # Bit  5: 
  # Bit  6: 
  # Bit  7: 
  # Bit  8: 
  # Bit  9: 
  # Bit 10: 
  # Bit 11: 
  # Bit 12: 
  # Bit 13: 
  # Bit 14: 
  # Bit 15: 
}

record( bo, "PANDA:$(subsys):HVCRATE:$(sector):Ctrl" ) {
  field( DTYP, "asynUInt32Digital" )
  field( OUT,  "@asynMask($(BUS),0,0x1,1)CONTROL" )
  #currently only bit 0 (clear events) of this 32-bit register is used
}       

record( bo, "PANDA:$(subsys):HVCRATE:$(sector):Switch" ) {
  field( DTYP, "asynInt32" )
  field( OUT,  "@asyn($(BUS),0,1)ON_OFF" )
  field( ZNAM, "Crate OFF" )
  field( ONAM, "Crate ON" )
}

record( bi, "PANDA:$(subsys):HVCRATE:$(sector):PowerOn" ){
  field( DTYP, "Soft Channel" )
  field( INP,  "PANDA:$(subsys):HVCRATE:$(sector):StatusHigh.B0" )
  field( ONAM, "Backplane On" )
  field( ZNAM, "Backplane Off" )
}
